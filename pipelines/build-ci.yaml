pool:
  name: Hosted Ubuntu 1604
  demands: maven

steps:
  - task: AzureResourceGroupDeployment@2
    displayName: 'Azure Deployment: Create Azure Container Registry'
    inputs:
      azureSubscription: 'conn-rg-kafka-spring-demo'
      resourceGroupName: 'rg-kafka-spring-demo'
      location: 'West Europe'
      csmFile: '$(System.DefaultWorkingDirectory)/**/container-registry-template.json'
      overrideParameters: '-registryName "kafkaonspringdemo"'

  - task: Maven@3
    displayName: 'Maven $(mavenPOMFile)'
    inputs:
      mavenPomFile: app/pom.xml
      testResultsFiles: '**/TEST*.xml'

  - task: Docker@1
    displayName: 'Build an image'
    inputs:
      azureSubscriptionEndpoint: 'conn-rg-kafka-spring-demo'
      azureContainerRegistry: kafkaonspringdemo.azurecr.io
      imageName: 'kafkaonspringdemo:$(Build.BuildId)'

  - task: Docker@1
    displayName: 'Push an image'
    inputs:
      azureSubscriptionEndpoint: 'conn-rg-kafka-spring-demo'
      azureContainerRegistry: kafkaonspringdemo.azurecr.io
      command: 'Push an image'
      imageName: 'kafkaonspringdemo:$(Build.BuildId)'

  - task: CopyFiles@2
    displayName: 'Copy ARM templates'
    inputs:
      SourceFolder: infra
      TargetFolder: '$(build.artifactstagingdirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      PathtoPublish: '$(build.artifactstagingdirectory)'
